
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>OS X System Ruby Encoding Annoyance - dl? cmplnts?</title>
  <meta name="author" content="Zhiming Wang">

  
  <meta name="description" content="I&rsquo;ve been using RVM (with fairly up-to-date Rubies) and pry since my day one with Ruby (well, almost), so it actually surprises me today when I &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://zmwangx.github.io/blog/2015/01/01/os-x-system-ruby-encoding-annoyance">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="dl? cmplnts?" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-53908325-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">dl? cmplnts?</a></h1>
  
    <h2>Mostly technical stuff. Can you figure out what the title stands for?</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:zmwangx.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">OS X System Ruby Encoding Annoyance</h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-01-01T22:49:39-08:00'><span class='date'><span class='date-month'>Jan</span> <span class='date-day'>1</span><span class='date-suffix'>st</span>, <span class='date-year'>2015</span></span> <span class='time'>10:49 pm</span></time>
        
           | <a href="#disqus_thread"
             data-disqus-identifier="http://zmwangx.github.io">Comments</a>
        
      </p>
    
  </header>


<div class="entry-content"><p>I&rsquo;ve been using RVM (with fairly up-to-date Rubies) and pry since my day one with Ruby (well, almost), so it actually surprises me today when I found out by chance how poorly the system Ruby behaves when it comes to encoding.</p>

<p>The major annoyance with the current system Ruby (2.0.0p481) is that it can&rsquo;t convert <code>UTF8-MAC</code> to <code>UTF-8</code> (namely, NFD to NFC, as far as I can tell), at least not with Korean characters. Consider the following script:</p>

<figure class='code'><figcaption><span>utf8-mac.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># coding: utf-8</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;hex_string&#39;</span>
</span><span class='line'><span class="n">str</span> <span class="o">=</span> <span class="s2">&quot;에이핑크&quot;</span>
</span><span class='line'><span class="nb">puts</span> <span class="n">str</span><span class="o">.</span><span class="n">to_hex_string</span>
</span><span class='line'><span class="nb">puts</span> <span class="n">str</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;UTF-8&quot;</span><span class="p">,</span> <span class="s2">&quot;UTF8-MAC&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">to_hex_string</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here are what I get with the system Ruby and the latested brewed Ruby:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>&gt; /usr/bin/ruby --version
</span><span class='line'>ruby 2.0.0p481 <span class="o">(</span>2014-05-08 revision 45883<span class="o">)</span> <span class="o">[</span>universal.x86_64-darwin14<span class="o">]</span>
</span><span class='line'>&gt; /usr/local/bin/ruby --version
</span><span class='line'>ruby 2.2.0p0 <span class="o">(</span>2014-12-25 revision 49005<span class="o">)</span> <span class="o">[</span>x86_64-darwin14<span class="o">]</span>
</span><span class='line'>&gt; /usr/bin/ruby utf8-mac.rb
</span><span class='line'>e1 <span class="m">84</span> 8b e1 <span class="m">85</span> a6 e1 <span class="m">84</span> 8b e1 <span class="m">85</span> b5 e1 <span class="m">84</span> <span class="m">91</span> e1 <span class="m">85</span> b5 e1 <span class="m">86</span> bc e1 <span class="m">84</span> 8f e1 <span class="m">85</span> b3
</span><span class='line'>e1 <span class="m">84</span> 8b e1 <span class="m">85</span> a6 e1 <span class="m">84</span> 8b e1 <span class="m">85</span> b5 e1 <span class="m">84</span> <span class="m">91</span> e1 <span class="m">85</span> b5 e1 <span class="m">86</span> bc e1 <span class="m">84</span> 8f e1 <span class="m">85</span> b3
</span><span class='line'>&gt; /usr/local/bin/ruby utf8-mac.rb
</span><span class='line'>e1 <span class="m">84</span> 8b e1 <span class="m">85</span> a6 e1 <span class="m">84</span> 8b e1 <span class="m">85</span> b5 e1 <span class="m">84</span> <span class="m">91</span> e1 <span class="m">85</span> b5 e1 <span class="m">86</span> bc e1 <span class="m">84</span> 8f e1 <span class="m">85</span> b3
</span><span class='line'>ec <span class="m">97</span> <span class="m">90</span> ec 9d b4 ed <span class="m">95</span> <span class="m">91</span> ed <span class="m">81</span> ac
</span></code></pre></td></tr></table></div></figure>


<p>As you can see, in the case of the system Ruby, NFD is left untouched. This leads to problems with, for instance, Google Translate. One obvious solution is to outsource the task to <code>iconv</code>, but I have the impression that outsourcing language features to shell commands is a generally despised practice.</p>

<p>There&rsquo;s one more surprise. While <code>pry</code> with latest Rubies tend to handle Unicode very well (unlike <code>irb</code>), I tried <code>pry</code> with the current system Ruby, and it doesn&rsquo;t work; due to this annoying limitation, I couldn&rsquo;t even test the above problem interactively, and had to resort to a script. Maybe the problem can be resolved by compiling Ruby with <code>readline</code> or whatever; I didn&rsquo;t bother. The bottom line is, the system Ruby is not very pleasant for men in the 21st century — good Unicode support ought to be a must. (By the way, NFD in HFS+ is maddening. It breaks Terminal, iTerm, Google Translate, scp with Linux hosts, and the list goes on.)</p>

<p>P.S. In Dropzone 3 custom actions you can select a custom Ruby with the <code>RubyPath</code> meta field, e.g.,</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># RubyPath: /usr/local/bin/ruby</span>
</span></code></pre></td></tr></table></div></figure>

</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Zhiming Wang</span></span>

      




<time class='entry-date' datetime='2015-01-01T22:49:39-08:00'><span class='date'><span class='date-month'>Jan</span> <span class='date-day'>1</span><span class='date-suffix'>st</span>, <span class='date-year'>2015</span></span> <span class='time'>10:49 pm</span></time>
      


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://zmwangx.github.io/blog/2015/01/01/os-x-system-ruby-encoding-annoyance/" data-via="" data-counturl="http://zmwangx.github.io/blog/2015/01/01/os-x-system-ruby-encoding-annoyance/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2014/12/23/mpv-launcher/" title="Previous Post: mpv launcher">&laquo; mpv launcher</a>
      
      
        <a class="basic-alignment right" href="/blog/2015/01/10/fonts-why-chinese-web-design-is-hard/" title="Next Post: Fonts: why Chinese web design is hard">Fonts: why Chinese web design is hard &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2015/02/20/my-dock-and-updated-omnifocus/">My Dock and Updated OmniFocus</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/02/17/microsoft-is-getting-cool-but-not-its-website/">Microsoft Is Getting Cool (but Not Its Website)</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/02/10/monitor-progress-of-your-unix-pipes-with-pv/">Monitor Progress of Your Unix Pipes With Pv</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/01/21/web-design-microsoft-vs-apple/">Web Design: Microsoft vs Apple</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/01/10/fonts-why-chinese-web-design-is-hard/">Fonts: Why Chinese Web Design Is Hard</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/zmwangx">@zmwangx</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'zmwangx',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015 - Zhiming Wang -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'zmwangx';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://zmwangx.github.io/blog/2015/01/01/os-x-system-ruby-encoding-annoyance/';
        var disqus_url = 'http://zmwangx.github.io/blog/2015/01/01/os-x-system-ruby-encoding-annoyance/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
